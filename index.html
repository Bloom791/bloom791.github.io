<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>User - Cassidy</title>

<!-- Pixel-style font (retro) -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #000000;
    --green: #00ff00; /* bright retro green */
    --dark-green: #008f00;
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--green);
    font-family: 'Press Start 2P', "Courier New", monospace;
    -webkit-font-smoothing: none;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeSpeed;
    user-select: none;
  }

  /* container */
  .screen{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
    background:var(--bg);
  }

  /* common retro text look */
  .retro-text{
    color:var(--green);
    text-shadow:
      0 0 0 var(--green),
      1px 1px 0 var(--dark-green);
    letter-spacing:2px;
    line-height:1.1;
    font-size:20px;
    text-transform:uppercase;
  }

  .panel{
    text-align:center;
    transform: translateZ(0);
  }

  button.retro-btn{
    margin-top:24px;
    background:transparent;
    border:2px solid var(--green);
    color:var(--green);
    padding:12px 18px;
    cursor:pointer;
    font-family:inherit;
    font-size:12px;
    letter-spacing:1px;
    transition: filter .08s;
  }
  button.retro-btn:active{ filter:brightness(.7); }

  /* Password screen layout */
  .password-screen{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  input.pw{
    margin-top:12px;
    background:transparent;
    border:2px solid var(--green);
    color:var(--green);
    padding:10px 12px;
    font-family:inherit;
    font-size:12px;
    outline:none;
    width:220px;
    text-align:center;
  }

  /* full-screen black overlay used for transitions */
  .full-black{
    position:absolute;
    inset:0;
    background:var(--bg);
    z-index:50;
    display:none;
  }

  /* welcome text (now with two lines) */
  .welcome{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:60;
    opacity:0;
    pointer-events:none;
    flex-direction:column;
    gap:6px;
  }
  .welcome .big { font-size:36px; }
  .welcome .small { font-size:20px; }

  /* fade-in animation (2s) */
  .fade-in{
    animation: welcomeFadeIn 2s forwards;
  }
  @keyframes welcomeFadeIn{
    from{ opacity:0; transform: scale(1.02); filter: blur(2px); }
    to  { opacity:1; transform: scale(1); filter: blur(0); }
  }

  /* desktop */
  .desktop{
    position:absolute;
    inset:0;
    background:var(--bg);
    z-index:10;
    display:none;
    flex-direction:column;
  }

  /* desktop icons area */
  .desktop-area{
    position:absolute;
    inset:0;
    padding:12px;
    box-sizing:border-box;
  }
  .desktop-icon{
    width:84px;
    text-align:center;
    color:var(--green);
    font-size:11px;
    cursor:default;
    display:inline-block;
    margin:6px;
    user-select:none;
  }
  .desktop-icon .icon-img{
    width:64px;
    height:64px;
    display:block;
    margin:0 auto 6px auto;
    image-rendering: pixelated;
    border:2px solid transparent;
  }
  .desktop-icon .label{
    display:block;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
  }
  .desktop-icon.selected .icon-img{
    outline:3px solid var(--green);
    outline-offset:2px;
    background:rgba(0,0,0,0.6);
  }
  .desktop-icon.selected .label{
    background:var(--dark-green);
    color:#000;
    padding:2px 4px;
    border-radius:2px;
    display:inline-block;
  }

  /* app window */
  .app-window{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:520px;
    max-width:92%;
    height:320px;
    background:var(--bg);
    border:2px solid var(--green);
    box-sizing:border-box;
    z-index:200;
    display:flex;
    flex-direction:column;
    visibility:hidden;
    opacity:0;
  }
  .app-window.show{
    visibility:visible;
    opacity:1;
  }

  .titlebar{
    height:34px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 8px;
    border-bottom:2px solid var(--green);
    box-sizing:border-box;
    cursor:grab;
  }
  .title{
    color:var(--green);
    font-size:12px;
    letter-spacing:1px;
  }
  .window-controls{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .ctl-btn{
    width:28px;
    height:22px;
    border:2px solid var(--green);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    background:transparent;
    color:var(--green);
    font-size:12px;
    line-height:1;
  }
  .ctl-btn:active{ filter:brightness(.8); }

  .window-body{
    padding:18px;
    flex:1;
    color:var(--green);
    overflow:auto;
    font-size:12px;
  }

  /* taskbar */
  .taskbar{
    position:absolute;
    left:0; right:0;
    bottom:0;
    height:40px;
    background:transparent;
    border-top:2px solid var(--green);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 8px;
    box-sizing:border-box;
    z-index:100;
  }
  .taskbar-left{
    display:flex;
    align-items:center;
    gap:6px;
    padding-left:6px;
  }
  .taskbar-right{
    display:flex;
    align-items:center;
    gap:8px;
    padding-right:6px;
  }

  .taskbar-btn{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 8px;
    min-width:36px;
    border:2px solid transparent;
    cursor:pointer;
    background:transparent;
    color:var(--green);
    font-size:11px;
  }
  .taskbar-btn.active{
    border:2px solid var(--green);
    background:var(--dark-green);
    color:#000;
  }
  .taskbar-btn img { width:20px; height:20px; image-rendering: pixelated; }

  .clock{
    color:var(--green);
    font-size:12px;
    letter-spacing:1px;
  }

  .pixelate{
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor;
  }

  /* accessibility: focus */
  button:focus, input:focus {
    outline: 2px dashed var(--dark-green);
    outline-offset:4px;
  }

  /* responsiveness */
  @media (min-width:900px){
    .retro-text{ font-size:22px; letter-spacing:3px; }
  }
</style>
</head>
<body>
  <div class="screen" id="screen">

    <!-- Initial splash showing Cassidy and Start button -->
    <div class="panel" id="splash">
      <div class="retro-text pixelate" style="font-size:28px">cassidy</div>
      <button class="retro-btn pixelate" id="startBtn">Start System</button>
      <!-- removed the © retro boot line as requested -->
    </div>

    <!-- Password screen (hidden initially) -->
    <div class="panel password-screen" id="passwordPanel" style="display:none;">
      <div class="retro-text pixelate small">password</div>
      <input class="pw pixelate" id="pwInput" type="password" autocomplete="off" inputmode="text" />
      <div style="display:flex; gap:12px; margin-top:12px;">
        <button class="retro-btn pixelate" id="submitPw">Submit</button>
        <button class="retro-btn pixelate" id="backBtn">Back</button>
      </div>
      <div id="pwMsg" class="small" style="margin-top:10px; color:var(--green); visibility:hidden;"> </div>
    </div>

    <!-- black overlay for the 1s blackout -->
    <div class="full-black pixelate" id="blackOverlay" style="display:none;"></div>

    <!-- Welcome text (now includes Cassidy under Welcome) -->
    <div class="welcome pixelate retro-text" id="welcomeText" style="display:none;">
      <div class="big">welcome</div>
      <div class="small">cassidy</div>
    </div>

    <!-- Desktop -->
    <div class="desktop" id="desktop">
      <div class="desktop-area" id="desktopArea">
        <!-- Entry - 1 file icon in top-left (original) -->
        <div class="desktop-icon" id="fileIcon" tabindex="0" data-filename="Entry - 1.txt">
          <img class="icon-img pixelate" src="https://files.catbox.moe/tcx2vu.png" alt="file icon" />
          <span class="label">Entry - 1</span>
        </div>

        <!-- Entry - 2 (new) -->
        <div class="desktop-icon" id="fileIcon2" tabindex="0" data-filename="Entry - 2.txt">
          <img class="icon-img pixelate" src="https://files.catbox.moe/tcx2vu.png" alt="file icon" />
          <span class="label">Entry - 2</span>
        </div>

        <!-- Entry - 3 (new) -->
        <div class="desktop-icon" id="fileIcon3" tabindex="0" data-filename="Entry - 3.txt">
          <img class="icon-img pixelate" src="https://files.catbox.moe/tcx2vu.png" alt="file icon" />
          <span class="label">Entry - 3</span>
        </div>
      </div>

      <!-- app window 1 (original) -->
      <div class="app-window" id="appWindow" role="dialog" aria-hidden="true" data-app="entry1">
        <div class="titlebar">
          <div class="title">Entry - 1 - Cassidy</div>
          <div class="window-controls">
            <div class="ctl-btn" id="minBtn" title="Minimize">—</div>
            <div class="ctl-btn" id="closeBtn" title="Close">✕</div>
          </div>
        </div>
        <div class="window-body">
          <div style="font-size:12px">11/16/2013 Pretty new to this entry thing. I guess this is just my diary. Well, I'm Cassidy. (Cassidy Vale).Today when I ran to the store, I bought these gloves were on sale so that's nice. I also got this sick-looking trenchcoat. I'll probably use it once it gets colder.</div>
        </div>
      </div>

      <!-- app window 2 (new) -->
      <div class="app-window" id="appWindow2" role="dialog" aria-hidden="true" data-app="entry2">
        <div class="titlebar">
          <div class="title">Entry - 2 - Cassidy</div>
          <div class="window-controls">
            <div class="ctl-btn" id="minBtn2" title="Minimize">—</div>
            <div class="ctl-btn" id="closeBtn2" title="Close">✕</div>
          </div>
        </div>
        <div class="window-body">
          <div style="font-size:12px">11/17/2013 Starting to get used to the entry thing. I prayed a bit, watched some television, nothing else is really important.</div>
        </div>
      </div>

      <!-- app window 3 (new) -->
      <div class="app-window" id="appWindow3" role="dialog" aria-hidden="true" data-app="entry3">
        <div class="titlebar">
          <div class="title">Entry - 3 - Cassidy</div>
          <div class="window-controls">
            <div class="ctl-btn" id="minBtn3" title="Minimize">—</div>
            <div class="ctl-btn" id="closeBtn3" title="Close">✕</div>
          </div>
        </div>
        <div class="window-body">
          <div style="font-size:12px">11/20/2013 It's been a bit. I've been worrying over this stupid stupid thing. I thought I saw someone, fuck that, someTHING there, at the treeline, just staring back at me. Of course I'm unreliable since it was only like 3 seconds but it still scared the shit out of me. Anyways, I gotta go, I'm having company over.</div>
        </div>
      </div>

      <div class="taskbar pixelate" role="toolbar" id="taskbar">
        <div class="taskbar-left" id="taskbarLeft">
          <!-- dynamic app buttons will appear here (order = open order; draggable to reorder) -->
        </div>
        <div class="taskbar-right">
          <div class="clock" id="clock">00:00:00</div>
        </div>
      </div>
    </div>

  </div>

<script>
  // Elements
  const startBtn = document.getElementById('startBtn');
  const splash = document.getElementById('splash');
  const passwordPanel = document.getElementById('passwordPanel');
  const submitPw = document.getElementById('submitPw');
  const backBtn = document.getElementById('backBtn');
  const pwInput = document.getElementById('pwInput');
  const pwMsg = document.getElementById('pwMsg');
  const blackOverlay = document.getElementById('blackOverlay');
  const welcomeText = document.getElementById('welcomeText');
  const desktop = document.getElementById('desktop');
  const clockEl = document.getElementById('clock');

  // Desktop app elements (multiple)
  const desktopArea = document.getElementById('desktopArea');
  const fileIcon = document.getElementById('fileIcon');   // entry1
  const fileIcon2 = document.getElementById('fileIcon2'); // entry2
  const fileIcon3 = document.getElementById('fileIcon3'); // entry3

  const appWindow = document.getElementById('appWindow');   // entry1 window
  const appWindow2 = document.getElementById('appWindow2'); // entry2 window
  const appWindow3 = document.getElementById('appWindow3'); // entry3 window

  // original control buttons (entry1)
  const minBtn = document.getElementById('minBtn');
  const closeBtn = document.getElementById('closeBtn');
  // entry2 controls
  const minBtn2 = document.getElementById('minBtn2');
  const closeBtn2 = document.getElementById('closeBtn2');
  // entry3 controls
  const minBtn3 = document.getElementById('minBtn3');
  const closeBtn3 = document.getElementById('closeBtn3');

  const taskbarLeft = document.getElementById('taskbarLeft');

  // Hard-coded password per request:
  const CORRECT = "cass";

  // Audio (plays when password screen opens; and when Welcome has fully faded in)
  const pwSound = new Audio('https://files.catbox.moe/t8ious.wav');
  const welcomeSound = new Audio('https://files.catbox.moe/s23l8n.wav');
  pwSound.preload = 'auto';
  welcomeSound.preload = 'auto';

  // global z-index counter so focused windows appear on top
  let highestZ = 200;
  let focusedAppId = null; // which app is focused

  // store app state in a simple map
  const apps = {
    'entry1': {
      id: 'entry1',
      fileEl: fileIcon,
      winEl: appWindow,
      minEl: minBtn,
      closeEl: closeBtn,
      title: 'Entry - 1',
      open: false,
      minimized: false,
      taskBtn: null
    },
    'entry2': {
      id: 'entry2',
      fileEl: fileIcon2,
      winEl: appWindow2,
      minEl: minBtn2,
      closeEl: closeBtn2,
      title: 'Entry - 2',
      open: false,
      minimized: false,
      taskBtn: null
    },
    'entry3': {
      id: 'entry3',
      fileEl: fileIcon3,
      winEl: appWindow3,
      minEl: minBtn3,
      closeEl: closeBtn3,
      title: 'Entry - 3',
      open: false,
      minimized: false,
      taskBtn: null
    }
  };

  // Start -> show password
  startBtn.addEventListener('click', () => {
    splash.style.display = 'none';
    passwordPanel.style.display = 'flex';
    pwInput.value = '';
    pwInput.focus();

    // play password sound once when the password screen appears
    try {
      pwSound.currentTime = 0;
      pwSound.play().catch(()=>{});
    } catch (e) { /* ignore */ }
  });

  backBtn.addEventListener('click', () => {
    passwordPanel.style.display = 'none';
    splash.style.display = 'block';
  });

  // Submit password logic
  submitPw.addEventListener('click', tryPassword);
  pwInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') tryPassword();
  });

  function showBlackOverlay() {
    blackOverlay.style.display = 'block';
  }
  function hideBlackOverlay() {
    blackOverlay.style.display = 'none';
  }

  function tryPassword(){
    const val = pwInput.value || '';
    if (val === CORRECT){
      pwMsg.style.visibility = 'hidden';

      // 1. hide password screen -> full black for 1s
      passwordPanel.style.display = 'none';
      showBlackOverlay();

      // wait 1s (1000ms), then show welcome with 2s fade-in
      setTimeout(() => {
        // show welcome overlay
        welcomeText.style.display = 'flex';
        welcomeText.classList.remove('fade-in');
        // trigger reflow so animation restarts properly
        void welcomeText.offsetWidth;
        welcomeText.classList.add('fade-in');

        // hide black overlay now (welcome will fade in on top)
        hideBlackOverlay();

        // after the 2s fade-in completes, wait 1s while fully visible, then go to desktop
        const fadeDuration = 2000;
        setTimeout(() => {
          // play welcome audio when fully faded in
          try {
            welcomeSound.currentTime = 0;
            welcomeSound.play().catch(()=>{});
          } catch (e) { /* ignore */ }

          // after fully faded in, wait 1s
          setTimeout(() => {
            // transition to black briefly then desktop
            showBlackOverlay();
            // small delay so the user sees the cut (instant black) - 200ms
            setTimeout(() => {
              // hide welcome
              welcomeText.style.display = 'none';
              hideBlackOverlay();
              // show desktop
              desktop.style.display = 'block';
              // start clock
              updateClock();
              setInterval(updateClock, 1000);
            }, 200);
          }, 1000);
        }, fadeDuration);
      }, 1000);
    } else {
      // wrong password feedback (in green but subtle)
      pwMsg.textContent = 'incorrect';
      pwMsg.style.visibility = 'visible';
      // quick flash for emphasis
      pwMsg.style.opacity = '1';
      setTimeout(()=>{ pwMsg.style.opacity = '0.6'; }, 600);
    }
  }

  // Clock/date formatting: show time and date like "11:03:12 11/19/2025"
  function updateClock(){
    const now = new Date();
    const p = (n) => String(n).padStart(2,'0');
    const hh = p(now.getHours());
    const mm = p(now.getMinutes());
    const ss = p(now.getSeconds());
    const month = p(now.getMonth()+1);
    const day = p(now.getDate());
    const year = now.getFullYear();
    clockEl.textContent = `${hh}:${mm}:${ss}  ${month}/${day}/${year}`;
  }

  // accessibility: allow focusing Start with keyboard
  startBtn.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') startBtn.click();
  });

  // Focus start button on load
  startBtn.focus();

  // ---------------------------
  // Desktop icon behavior (single-click select, double-click open)
  // ---------------------------
  let lastClickTime = 0;
  let clickTimeout = null;
  const DOUBLE_CLICK_MS = 350;

  function selectIcon(el) {
    // clear other selections
    document.querySelectorAll('.desktop-icon.selected').forEach(node => node.classList.remove('selected'));
    el.classList.add('selected');
  }
  function deselectAllIcons() {
    document.querySelectorAll('.desktop-icon.selected').forEach(node => node.classList.remove('selected'));
  }

  // helper to attach icon handlers for each app
  function attachIconHandlers(app) {
    const el = app.fileEl;
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const now = Date.now();
      const delta = now - lastClickTime;
      lastClickTime = now;

      // handle double click
      if (delta < DOUBLE_CLICK_MS) {
        // double-click detected
        openApp(app.id);
        clearTimeout(clickTimeout);
        clickTimeout = null;
        return;
      }

      // single click -> select after small delay unless double click occurs
      selectIcon(el);
      if (clickTimeout) clearTimeout(clickTimeout);
      clickTimeout = setTimeout(() => {
        // single-click confirm (we already selected visually)
        clickTimeout = null;
      }, DOUBLE_CLICK_MS + 10);
    });

    // keyboard open on Enter
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') openApp(app.id);
    });
  }

  // Attach for all apps
  Object.values(apps).forEach(attachIconHandlers);

  // clicking on desktop background deselects icons
  desktopArea.addEventListener('click', (e) => {
    deselectAllIcons();
  });

  // ---------------------------
  // Taskbar / App logic for multiple apps
  // ---------------------------

  // Create a taskbar button for a specific app id (if not already created)
  function createTaskbarButtonFor(appId) {
    const app = apps[appId];
    if (!app) return null;
    if (app.taskBtn) return app.taskBtn;

    const btn = document.createElement('button');
    btn.className = 'taskbar-btn pixelate';
    btn.title = app.title;
    btn.draggable = true; // allow drag to reorder
    // set a data attribute
    btn.dataset.appId = appId;

    const img = document.createElement('img');
    img.src = 'https://files.catbox.moe/tcx2vu.png';
    img.alt = 'app';
    btn.appendChild(img);
    const label = document.createElement('span');
    label.textContent = app.title;
    label.style.fontSize = '10px';
    btn.appendChild(label);

    // clicking toggles minimize/restore
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!app.open) return;
      if (app.minimized) {
        restoreApp(appId);
      } else {
        minimizeApp(appId);
      }
    });

    // Drag-and-drop handlers for reordering the taskbar buttons
    btn.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', appId);
      btn.classList.add('dragging');
      // store a simple global dragged id
      draggedTaskbarId = appId;
      setTimeout(()=> btn.classList.add('hidden-drag'), 0);
    });
    btn.addEventListener('dragend', (e) => {
      btn.classList.remove('dragging', 'hidden-drag');
      draggedTaskbarId = null;
    });

    btn.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    btn.addEventListener('drop', (e) => {
      e.preventDefault();
      const draggedId = e.dataTransfer.getData('text/plain');
      const targetId = appId;
      if (!draggedId || draggedId === targetId) return;
      // move dragged button before the target button
      const draggedBtn = taskbarLeft.querySelector(`[data-app-id="${draggedId}"]`);
      const targetBtn = taskbarLeft.querySelector(`[data-app-id="${targetId}"]`);
      if (draggedBtn && targetBtn) {
        taskbarLeft.insertBefore(draggedBtn, targetBtn);
      }
    });

    taskbarLeft.appendChild(btn);
    app.taskBtn = btn;
    return btn;
  }

  // Remove taskbar button for an app
  function removeTaskbarButtonFor(appId) {
    const app = apps[appId];
    if (!app || !app.taskBtn) return;
    app.taskBtn.remove();
    app.taskBtn = null;
  }

  // Bring an app window to front and mark focused
  function focusApp(appId) {
    const app = apps[appId];
    if (!app) return;
    // unfocus previous
    if (focusedAppId && apps[focusedAppId] && apps[focusedAppId].taskBtn) {
      apps[focusedAppId].taskBtn.classList.remove('active');
    }
    // bring this to front
    highestZ++;
    app.winEl.style.zIndex = highestZ;
    focusedAppId = appId;
    if (app.taskBtn) app.taskBtn.classList.add('active');
  }

  // Open app
  function openApp(appId) {
    const app = apps[appId];
    if (!app) return;
    if (!app.open) {
      app.open = true;
      app.minimized = false;
      // create taskbar button (append = open order)
      createTaskbarButtonFor(appId);
    }
    // show window
    app.winEl.classList.add('show');
    app.winEl.style.visibility = 'visible';
    app.winEl.style.opacity = '1';
    app.winEl.setAttribute('aria-hidden','false');
    app.minimized = false;
    focusApp(appId);
    // select desktop icon
    selectIcon(app.fileEl);
  }

  // Minimize app
  function minimizeApp(appId) {
    const app = apps[appId];
    if (!app || !app.open) return;
    app.minimized = true;
    app.winEl.style.visibility = 'hidden';
    app.winEl.style.opacity = '0';
    app.winEl.setAttribute('aria-hidden','true');
    if (app.taskBtn) app.taskBtn.classList.remove('active');
    // if it was focused, clear focus
    if (focusedAppId === appId) focusedAppId = null;
  }

  // Restore app
  function restoreApp(appId) {
    const app = apps[appId];
    if (!app || !app.open) return;
    app.minimized = false;
    app.winEl.style.visibility = 'visible';
    app.winEl.style.opacity = '1';
    app.winEl.setAttribute('aria-hidden','false');
    focusApp(appId);
  }

  // Close app
  function closeApp(appId) {
    const app = apps[appId];
    if (!app || !app.open) return;
    app.open = false;
    app.minimized = false;
    app.winEl.style.visibility = 'hidden';
    app.winEl.style.opacity = '0';
    app.winEl.setAttribute('aria-hidden','true');
    removeTaskbarButtonFor(appId);
    deselectAllIcons();
    if (focusedAppId === appId) focusedAppId = null;
  }

  // Attach taskbar buttons and controls for each app
  function attachWindowControls(app) {
    // min button
    if (app.minEl) {
      app.minEl.addEventListener('click', (e) => {
        e.stopPropagation();
        minimizeApp(app.id);
      });
    }
    // close button
    if (app.closeEl) {
      app.closeEl.addEventListener('click', (e) => {
        e.stopPropagation();
        closeApp(app.id);
      });
    }

    // clicking inside the window should bring it to front and prevent deselecting
    if (app.winEl) {
      app.winEl.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        // if hidden (minimized) do nothing
        const styleVis = window.getComputedStyle(app.winEl).visibility;
        if (styleVis === 'hidden') return;
        focusApp(app.id);
      });
    }
  }

  // Attach for all apps
  Object.values(apps).forEach(attachWindowControls);

  // ---------------------------
  // Drag-to-move windows (constrained)
  // ---------------------------

  // Reusable drag setup for titlebars for each app window
  function setupWindowDrag(app) {
    const titlebar = app.winEl.querySelector('.titlebar');
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    function onPointerDown(e) {
      // ignore right/middle buttons
      if (typeof e.button === 'number' && e.button !== 0) return;
      // don't start drag if clicking a control button
      if (e.target.closest('.ctl-btn')) return;
      // only drag when window is visible
      const styleVis = window.getComputedStyle(app.winEl).visibility;
      if (styleVis === 'hidden') return;

      const rect = app.winEl.getBoundingClientRect();
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;

      // switch to explicit pixel positioning (remove centering transform)
      app.winEl.style.left = rect.left + 'px';
      app.winEl.style.top = rect.top + 'px';
      app.winEl.style.transform = 'none';

      // capture pointer for smoother dragging if available
      try { app.winEl.setPointerCapture(e.pointerId); } catch (err) {}
      isDragging = true;
      e.preventDefault();
    }

    function onPointerMove(e) {
      if (!isDragging) return;
      const rectW = app.winEl.offsetWidth;
      const rectH = app.winEl.offsetHeight;
      let newLeft = e.clientX - dragOffsetX;
      let newTop = e.clientY - dragOffsetY;

      // clamp so window can't be dragged off-screen
      const minLeft = 0;
      const maxLeft = Math.max(0, window.innerWidth - rectW);
      const minTop = 0;
      // keep above taskbar (approx 40px height)
      const maxTop = Math.max(0, window.innerHeight - rectH - 40);

      if (newLeft < minLeft) newLeft = minLeft;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop < minTop) newTop = minTop;
      if (newTop > maxTop) newTop = maxTop;

      app.winEl.style.left = newLeft + 'px';
      app.winEl.style.top = newTop + 'px';
    }

    function onPointerUp(e) {
      if (!isDragging) return;
      isDragging = false;
      try { app.winEl.releasePointerCapture(e.pointerId); } catch (err) {}
    }

    titlebar.addEventListener('pointerdown', onPointerDown);
    document.addEventListener('pointermove', onPointerMove);
    document.addEventListener('pointerup', onPointerUp);
  }

  // Setup dragging for each app
  Object.values(apps).forEach(setupWindowDrag);

  // ---------------------------
  // Hook up icons to open corresponding apps (map icons -> app ids)
  // ---------------------------
  fileIcon.addEventListener('dblclick', () => openApp('entry1'));
  fileIcon2.addEventListener('dblclick', () => openApp('entry2'));
  fileIcon3.addEventListener('dblclick', () => openApp('entry3'));

  // For users who double-click fast, keep supporting the earlier single/double logic:
  fileIcon.addEventListener('click', (e)=>{/* handled above by attachIconHandlers */});
  fileIcon2.addEventListener('click', (e)=>{/* handled above by attachIconHandlers */});
  fileIcon3.addEventListener('click', (e)=>{/* handled above by attachIconHandlers */});

  // ---------------------------
  // Taskbar drag state variable
  // ---------------------------
  let draggedTaskbarId = null;

  // Prevent accidental text selection on double clicks
  document.addEventListener('selectstart', (e) => { e.preventDefault(); });

  // clicking taskbar area or clock doesn't deselect icons
  document.getElementById('taskbar').addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // clicking outside any icon or window should deselect
  document.addEventListener('click', (e) => {
    const isClickOnIcon = e.target.closest('.desktop-icon');
    const isClickOnWindow = e.target.closest('.app-window');
    if (!isClickOnIcon && !isClickOnWindow) {
      deselectAllIcons();
    }
  });

  // Keep the rest of original behavior intact (clock, etc.)

  // NOTE: existing code logic preserved where possible; new multi-app logic is additive.
</script>
</body>
</html>
